trigger:
  branches:
    include:
      - main
# variables:
#   - group: Mobile # Change it to the name you have set
pool:
  vmImage: 'macos-latest'
steps:
  - checkout: self
    persistCredentials: true
    clean: true

  - task: NodeTool@0
    displayName: 'Install Node'
    inputs:
      versionSpec: '23.x' # Use your desired version here

  - script: npm install
    displayName: Install Dependencies

  # - script: |
  #     # Disable autocommit on version bump
  #     yarn config set version-sign-git-tag false
  #     yarn config set version-git-tag false
  #     yarn config set version-commit-hooks false
  #     # Checkout branch where the build is triggered
  #     git checkout $(Build.SourceBranchName)
  #     # Extract existing version of package.json
  #     oldVer=$(jq -r ".version" package.json)
  #     # Bump version
  #     yarn version --patch
  #     # Add bumped version to staging
  #     git add *
  #     # Extract new version of package.json
  #     newVer=$(jq -r ".version" package.json)
  #     # Set environment variables
  #     echo "##vso[task.setvariable variable=OLD_VERSION]$oldVer"
  #     echo "##vso[task.setvariable variable=NEW_VERSION]$newVer"
  #   displayName: 'Bump version and set variables'

  - task: Gradle@3
    displayName: 'Build APK'
    inputs:
      workingDirectory: 'android/'
      options: './gradlew assembleRelease -PversionName=$(NEW_VERSION) -PversionCode=$(Build.BuildId)'
      tasks: 'assembleRelease'
      publishJUnitResults: false
      javaHomeOption: 'JDKVersion'
      jdkVersionOption: '1.8'
      gradleOptions: '-Xmx3072m'
      sonarQubeRunAnalysis: false

  - task: PublishBuildArtifacts@1
    displayName: 'Publish APK to artifacts'
    inputs:
      PathtoPublish: 'android/app/build/outputs/apk/release'
      ArtifactName: 'android'
      publishLocation: 'Container'

  - task: AzureFileCopy@4
    inputs:
      SourcePath: '$(System.DefaultWorkingDirectory)/android/app/build/outputs/'
      azureSubscription: 'subscription'  # Replace with your Azure subscription service connection
      Destination: 'AzureBlob'
      storage: '$(STORAGE_ACCOUNT)'  # Replace with your Azure Storage account name
      ContainerName: '$(CONTAINER_NAME)'  # Replace with the Azure Blob container name
      BlobPrefix: 'react-native-builds/'  # Prefix to categorize builds
    displayName: 'Upload APK and App Bundle to Azure Blob Storage'
